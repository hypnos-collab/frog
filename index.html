<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心理測驗活動系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- 導覽手冊彈窗 -->
    <div id="guide-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-6">
        <div class="bg-white rounded-2xl max-w-lg w-full p-8 relative shadow-2xl animate-fade-in">
            <button onclick="toggleGuide(false)" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                使用手冊
            </h2>
            <div class="space-y-4 text-slate-600">
                <p><strong>1. 如何實際上線？</strong><br>這是一個單一 HTML 檔案，您可以將其上傳到任何網頁空間，或直接使用瀏覽器開啟。</p>
                <p><strong>2. 如何修改題目？</strong><br>搜尋程式碼中的 <code>QUIZ_DATA</code> 變數，直接修改其中的中文文字即可。</p>
                <p><strong>3. 數據安全嗎？</strong><br>資料會即時存儲在 Firebase 雲端資料庫。系統會自動進行匿名登入以符合安全性規範。</p>
            </div>
            <button onclick="toggleGuide(false)" class="mt-6 w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors">我知道了</button>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl border border-slate-100 overflow-hidden relative min-h-[500px] flex flex-col">
        
        <!-- Welcome Step -->
        <div id="step-welcome" class="step-content active p-10 text-center space-y-6 animate-fade-in">
            <div class="bg-blue-100 w-24 h-24 rounded-3xl flex items-center justify-center mx-auto text-blue-600 rotate-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
            </div>
            <h1 id="main-title" class="text-3xl font-black text-slate-800">載入中...</h1>
            <p id="main-desc" class="text-slate-500 leading-relaxed"></p>
            <button onclick="goToStep('form')" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold text-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">
                開始測驗
            </button>
            <button onclick="toggleGuide(true)" class="text-slate-400 text-sm flex items-center justify-center gap-1 mx-auto hover:underline">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                這是什麼？我該怎麼操作？
            </button>
        </div>

        <!-- Form Step -->
        <div id="step-form" class="step-content p-8 space-y-6 animate-fade-in">
            <div class="space-y-2">
                <h2 class="text-2xl font-bold text-slate-800">登錄資料</h2>
                <p class="text-sm text-slate-400">測議結果將與此資料一併儲存</p>
            </div>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-400 uppercase">姓名</label>
                    <input id="input-name" type="text" placeholder="請輸入姓名" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-400 uppercase">聯絡電話</label>
                    <input id="input-phone" type="tel" placeholder="請輸入電話" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <button id="btn-start-quiz" onclick="startQuiz()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all disabled:bg-slate-300">
                    下一步
                </button>
            </div>
        </div>

        <!-- Quiz Step -->
        <div id="step-quiz" class="step-content p-8 space-y-8 animate-fade-in h-full flex flex-col relative">
            <div class="flex justify-between items-center text-xs font-bold text-slate-300">
                <span id="quiz-progress-text" class="uppercase tracking-widest">Question 1</span>
                <span id="quiz-percentage">0%</span>
            </div>
            <h2 id="quiz-question-text" class="text-2xl font-bold text-slate-800 leading-snug min-h-[3.5em]">載入題目中...</h2>
            <div id="quiz-options" class="space-y-3">
                <!-- 選項會透過 JS 產生 -->
            </div>
            <div id="quiz-loading" class="absolute inset-0 bg-white/90 hidden flex-col items-center justify-center backdrop-blur-sm z-50">
                <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
                <p class="font-bold text-slate-600 text-lg">正在解析你的性格...</p>
            </div>
        </div>

        <!-- Result Step -->
        <div id="step-result" class="step-content p-10 text-center space-y-8 animate-fade-in">
            <div class="space-y-2">
                <span class="text-blue-500 font-bold text-sm tracking-widest uppercase">測驗結果分析</span>
                <h2 id="result-title" class="text-4xl font-black text-slate-800">分析結果</h2>
            </div>
            <div class="bg-slate-50 p-8 rounded-3xl border-2 border-white shadow-inner">
                <p id="result-desc" class="text-slate-600 leading-relaxed text-lg italic"></p>
            </div>
            <button onclick="location.reload()" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 transition-all">
                再測一次
            </button>
            <p class="text-xs text-slate-400">數據已成功儲存至後端資料庫</p>
        </div>

        <!-- Admin Step -->
        <div id="step-admin" class="step-content p-6 space-y-4 h-[550px] flex flex-col animate-fade-in">
            <div class="flex justify-between items-center border-b pb-4">
                <h2 class="font-bold text-lg flex items-center gap-2 text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    後台數據中心
                </h2>
                <span id="admin-count" class="bg-blue-100 text-blue-600 px-2 py-1 rounded-md text-xs font-bold">0 筆資料</span>
            </div>
            <div id="admin-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                <div class="text-center py-10 text-slate-300 italic">正在載入數據...</div>
            </div>
            <button onclick="goToStep('welcome')" class="w-full py-3 bg-slate-100 text-slate-500 font-bold rounded-xl text-sm">返回首頁</button>
        </div>
    </div>

    <!-- 快捷按鈕 -->
    <div class="fixed bottom-6 right-6 flex flex-col gap-3">
        <button onclick="toggleGuide(true)" class="p-4 bg-white shadow-xl rounded-full text-blue-500 hover:scale-110 transition-all border border-blue-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </button>
        <button onclick="goToStep('admin')" class="p-4 bg-white shadow-xl rounded-full text-slate-400 hover:text-blue-600 hover:scale-110 transition-all border border-slate-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        </button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- 配置數據 ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-event-quiz';
        
        const QUIZ_DATA = {
            title: "活動心理測驗：你的性格原型",
            description: "歡迎參加本次活動！請花 1 分鐘回答問題，領取你的專屬分析。",
            questions: [
                {
                    text: "在社交場合中，你通常是？",
                    options: [
                        { text: "主動找人聊天的核心人物", category: "外向", points: 2 },
                        { text: "待在熟人身邊安靜觀察", category: "內向", points: 2 },
                        { text: "負責張羅食物與場地的細節控", category: "細節", points: 2 },
                        { text: "觀察氣氛並適時幽默的人", category: "觀察", points: 2 }
                    ]
                },
                {
                    text: "面對突發狀況，你的直覺反應是？",
                    options: [
                        { text: "馬上行動解決問題", category: "外向", points: 2 },
                        { text: "冷靜分析各種可能性", category: "內向", points: 2 },
                        { text: "確認所有細節是否正確", category: "細節", points: 2 },
                        { text: "看看大家的反應再做決定", category: "觀察", points: 2 }
                    ]
                }
            ],
            results: {
                "外向": { title: "耀眼的太陽", desc: "你充滿活力，是團隊中不可或缺的驅動力！" },
                "內向": { title: "深邃的星空", desc: "你心思細膩，總能洞察他人忽略的重點。" },
                "細節": { title: "精密的羅盤", desc: "你非常可靠，有你在大家都很放心。" },
                "觀察": { title: "清澈的湖泊", desc: "你擅長平衡與協調，是最佳的智囊團。" }
            }
        };

        // --- 初始化 Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 全域狀態 ---
        let currentStep = 'welcome';
        let formData = { name: '', phone: '' };
        let currentQuestionIndex = 0;
        let scores = { 外向: 0, 內向: 0, 細節: 0, 觀察: 0 };
        let submissions = [];
        let isAuthReady = false;

        // --- 核心功能函數 ---
        window.goToStep = (step) => {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
        };

        window.toggleGuide = (show) => {
            const modal = document.getElementById('guide-modal');
            modal.style.display = show ? 'flex' : 'none';
        };

        window.startQuiz = () => {
            if (!isAuthReady) return alert("系統初始化中，請稍候...");
            const name = document.getElementById('input-name').value;
            const phone = document.getElementById('input-phone').value;
            if (!name) return alert("請輸入姓名");
            formData = { name, phone };
            renderQuestion();
            goToStep('quiz');
        };

        const renderQuestion = () => {
            const question = QUIZ_DATA.questions[currentQuestionIndex];
            document.getElementById('quiz-progress-text').innerText = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('quiz-percentage').innerText = `${Math.round(((currentQuestionIndex + 1) / QUIZ_DATA.questions.length) * 100)}%`;
            document.getElementById('quiz-question-text').innerText = question.text;

            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full p-5 text-left border-2 border-slate-100 rounded-2xl hover:bg-blue-50 hover:border-blue-200 transition-all group flex justify-between items-center";
                btn.innerHTML = `
                    <span class="text-slate-600 font-medium group-hover:text-blue-700">${opt.text}</span>
                    <svg class="text-slate-200 group-hover:text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                `;
                btn.onclick = () => handleAnswer(opt.category, opt.points);
                optionsContainer.appendChild(btn);
            });
        };

        const handleAnswer = async (category, points) => {
            scores[category] += points;
            
            if (currentQuestionIndex < QUIZ_DATA.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                await finishQuiz();
            }
        };

        const finishQuiz = async () => {
            document.getElementById('quiz-loading').style.display = 'flex';
            
            const topCategory = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            const result = QUIZ_DATA.results[topCategory];

            // 儲存資料到 Firebase (Rule 3: 確保有用戶後才寫入)
            try {
                if (auth.currentUser) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results'), {
                        ...formData,
                        result: topCategory,
                        timestamp: serverTimestamp(),
                        scores: scores
                    });
                }
            } catch (e) {
                console.error("儲存失敗", e);
            }

            // 顯示結果
            document.getElementById('result-title').innerText = result.title;
            document.getElementById('result-desc').innerText = `「${result.desc}」`;
            goToStep('result');
            document.getElementById('quiz-loading').style.display = 'none';
        };

        // --- 初始化頁面 ---
        window.onload = async () => {
            document.getElementById('main-title').innerText = QUIZ_DATA.title;
            document.getElementById('main-desc').innerText = QUIZ_DATA.description;

            // 1. 執行身份驗證 (Rule 3: 必須先 await 登入)
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                isAuthReady = true;
                
                // 2. 登入成功後才啟動監聽器
                startDataListener();
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.getElementById('admin-list').innerHTML = '<div class="text-center py-10 text-red-400">登入失敗，請重新整理頁面。</div>';
            }
        };

        const startDataListener = () => {
            // 使用 Rule 1 的路徑
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'quiz_results'));
            
            // 加入錯誤回調以防止權限問題導致無聲失敗
            onSnapshot(q, (snapshot) => {
                submissions = snapshot.docs.map(doc => doc.data());
                renderAdmin();
            }, (error) => {
                console.error("Firestore Error:", error);
                if (error.code === 'permission-denied') {
                    document.getElementById('admin-list').innerHTML = '<div class="text-center py-10 text-red-400 italic">權限不足，請確認後台配置。</div>';
                }
            });
        };

        const renderAdmin = () => {
            document.getElementById('admin-count').innerText = `${submissions.length} 筆資料`;
            const list = document.getElementById('admin-list');
            list.innerHTML = '';
            
            if (submissions.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-slate-300 italic">尚無數據傳回...</div>';
                return;
            }

            // 依照時間排序 (Rule 2: 簡單排序在記憶體中進行)
            const sortedSubmissions = [...submissions].sort((a, b) => {
                const timeA = a.timestamp?.seconds || 0;
                const timeB = b.timestamp?.seconds || 0;
                return timeB - timeA;
            });

            sortedSubmissions.forEach(s => {
                const item = document.createElement('div');
                item.className = "p-4 bg-slate-50 rounded-2xl border border-slate-100 space-y-1 animate-fade-in";
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-slate-700">${s.name || '匿名'}</span>
                        <span class="text-[10px] text-slate-400 uppercase">${s.timestamp ? new Date(s.timestamp.seconds * 1000).toLocaleDateString() : '剛剛'}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-xs text-slate-400">${s.phone || '-'}</span>
                        <span class="px-2 py-1 bg-white text-blue-600 rounded-lg text-[10px] font-bold border border-blue-100">${s.result}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        };
    </script>
</body>
</html>